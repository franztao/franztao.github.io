---
layout:     post
title:      样式和格式代码
subtitle:   2022年10月
date:       2022-10-10
author:     franztao
header-img: post-bg-re-vs-ng2.jpg
catalog: true
tags:
    -Styling and Formatting Code

---


## 直觉

> 阅读代码的频率高于编写代码的频率。——Guido [Van Rossum](https://en.wikipedia.org/wiki/Guido_van_Rossum)（Python 的作者）

当我们编写一段代码时，几乎从来都不是我们最后一次看到它或最后一次编辑它。所以我们需要解释发生了什么（通过[文档](https://madewithml.com/courses/mlops/documentation/)）并使其易于阅读。使代码更具可读性的最简单方法之一是遵循一致的样式和格式约定。在遵守 Python 样式约定方面有很多选择，但大多数都基于[PEP8](https://www.python.org/dev/peps/pep-0008/)约定。不同的团队遵循不同的约定，这完全没问题。最重要的方面是：

-   `consistency`: 每个人都遵循相同的标准。
-   `automation`：在初始配置后，格式化应该很容易。

我们将使用非常流行的风格和格式约定的混合，代表我们做出一些非常固执的决定（带有可配置的选项）。

-   [`Black`](https://black.readthedocs.io/en/stable/)：一个就地重新格式化程序，（大部分）[遵守](https://black.readthedocs.io/en/stable/the_black_code_style/current_style.html)PEP8。
-   [`isort`](https://pycqa.github.io/isort/): 对 Python 脚本中的 import 语句进行排序和格式化。
-   [`flake8`](https://flake8.pycqa.org/en/latest/index.html): 具有符合 PEP8 的风格约定的代码 linter。

安装所需的软件包：

```
pip install black==22.3.0 flake8==3.9.2 isort==5.10.1

```

由于这些样式包不是核心机器学习操作的组成部分，让我们在我们的 中创建一个单独的列表`setup.py`：

<table><tbody><tr><td><div><pre><span></span><span><span><span>1 </span></span></span>
<span><span><span>2 </span></span></span>
<span><span><span>3 </span></span></span>
<span><span><span>4 </span></span></span>
<span><span><span>5 </span></span></span>
<span><span><span>6 </span></span></span>
<span><span><span>7 </span></span></span>
<span><span><span>8 </span></span></span>
<span><span><span>9 </span></span></span>
<span><span><span>10 </span></span></span>
<span><span><span>11 </span></span></span>
<span><span><span>12 </span></span></span>
<span><span><span>13 </span></span></span>
<span><span><span>14 </span></span></span>
<span><span><span>15</span></span></span></pre></div></td><td><div><pre><span></span><code><span># setup.py</span>
<span>style_packages</span> <span>=</span> <span>[</span>
    <span>"black==22.3.0"</span><span>,</span>
    <span>"flake8==3.9.2"</span><span>,</span>
    <span>"isort==5.10.1"</span>
<span>]</span><span></span>
<span></span>
<span># Define our package</span>
<span>setup</span><span>(</span>
    <span>...</span>
    <span>extras_require</span><span>=</span><span>{</span>
<span>        <span>"dev"</span><span>:</span> <span>docs_packages</span> <span>+</span> <span>style_packages</span><span>,</span>
</span>        <span>"docs"</span><span>:</span> <span>docs_packages</span><span>,</span>
    <span>},</span>
<span>)</span>
</code></pre></div></td></tr></tbody></table>

> Unlike `docs`, we don't add `style_packages` as a separate `extras_require` because there is no need for someone to install just the style packages. So we can just add it to the `dev` option.

## Configuration

Before we can properly use these tools, we'll have to configure them because they may have some discrepancies amongst them since they follow slightly different conventions that extend from PEP8.

### Black

To configure Black, we could just pass in options using the [CLI method](https://black.readthedocs.io/en/stable/usage_and_configuration/the_basics.html#command-line-options), but it's much more efficient (especially so others can easily find all our configurations) to do this through a file. So we'll create a `pyproject.toml` in the root of our project directory with the following:

<table><tbody><tr><td><div><pre><span></span><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span></pre></div></td><td><div><pre><span></span><code><span># Black formatting</span><span></span>
<span>[tool.black]</span><span></span>
<span>line-length</span><span> </span><span>=</span><span> </span><span>100</span><span></span>
<span>include</span><span> </span><span>=</span><span> </span><span>'\.pyi?$'</span><span></span>
<span>exclude</span><span> </span><span>=</span><span> </span><span>'''</span>
<span>/(</span>
<span>      .eggs         # exclude a few common directories in the</span>
<span>    | .git          # root of the project</span>
<span>    | .hg</span>
<span>    | .mypy_cache</span>
<span>    | .tox</span>
<span>    | venv</span>
<span>    | _build</span>
<span>    | buck-out</span>
<span>    | build</span>
<span>    | dist</span>
<span>  )/</span>
<span>'''</span><span></span>
</code></pre></div></td></tr></tbody></table>

Here we're telling Black that our maximum line length should be 100 characters and to include and exclude certain file extensions.

> The [pyproject.toml](https://www.python.org/dev/peps/pep-0518/#file-format) was created to establish a more human-readable configuration file that is meant to replace a `setup.py` or `setup.cfg` file and is increasingly adopted by many open-source libraries.

### isort

Next, we're going to configure isort in our `pyproject.toml` file (just below Black's configurations):

<table><tbody><tr><td></td><td><div><pre><span></span><code><span># iSort</span><span></span>
<span>[tool.isort]</span><span></span>
<span>profile</span><span> </span><span>=</span><span> </span><span>"black"</span><span></span>
<span>line_length</span><span> </span><span>=</span><span> </span><span>79</span><span></span>
<span>multi_line_output</span><span> </span><span>=</span><span> </span><span>3</span><span></span>
<span>include_trailing_comma</span><span> </span><span>=</span><span> </span><span>true</span><span></span>
<span>virtual_env</span><span> </span><span>=</span><span> </span><span>"venv"</span><span></span>
</code></pre></div></td></tr></tbody></table>

Though there is a [complete list](https://pycqa.github.io/isort/docs/configuration/options) of configuration options for isort, we've decided to set these explicitly so there are no conflicts with Black.

### flake8

Lastly, we'll set up flake8, but this time we need to create a separate `.flake8` file to define its configurations:

<table><tbody><tr><td></td><td><div><pre><span></span><code><span>[flake8]</span><span></span>
<span>exclude</span><span> </span><span>=</span><span> </span><span>venv</span><span></span>
<span>ignore</span><span> </span><span>=</span><span> </span><span>E501</span><span>,</span><span> </span><span>W503</span><span>,</span><span> </span><span>E226</span><span></span>
<span>max-line-length</span><span> </span><span>=</span><span> </span><span>79</span><span></span><span></span>
<span></span>
<span># E501: Line too long</span><span></span>
<span># W503: Line break occurred before binary operator</span><span></span>
<span># E226: Missing white space around arithmetic operator</span><span></span>
</code></pre></div></td></tr></tbody></table>

Here we're including an `ignore` option to ignore certain [flake8 rules](https://www.flake8rules.com/) so everything works with our Black and isort configurations.

Besides defining configuration options here, which are applied globally, we can also choose to specifically ignore certain conventions on a line-by-line basis. Here is an example of how we utilize this:

<table><tbody><tr><td></td><td><div><pre><span></span><code><span># tagifai/config.py</span>
<span>import</span> <span>pretty_errors</span>  <span># NOQA: F401 (imported but unused)</span>
</code></pre></div></td></tr></tbody></table>

By placing the `# NOQA: <error-code>` on a line, we're telling flake8 to do **NO** _Q_uality _A_ssurance for that particular error on this line.

## Usage

To use these tools that we've configured, we have to execute them from the project directory:

```
black .
All done! ✨ 🍰 ✨
9 files left unchanged.
flake8
python3 -m isort . isort .
Fixing ...

```

Take a look at your files to see all the changes that have been made!

> the `.` signifies that the configuration file for that package is in the current directory

In our [makefile lesson](https://madewithml.com/courses/mlops/makefile/) we'll learn how to combine all these commands into one. And in our [pre-commit lesson](https://pre-commit.com/) we'll learn how to automatically execute this formatting whenever we make changes to our code.

___

要引用此内容，请使用：

<table><tbody><tr><td></td><td><div><pre><span></span><code><span>@article</span><span>{</span><span>madewithml</span><span>,</span><span></span>
<span>    </span><span>author</span><span>       </span><span>=</span><span> </span><span>{Goku Mohandas}</span><span>,</span><span></span>
<span>    </span><span>title</span><span>        </span><span>=</span><span> </span><span>{ Styling - Made With ML }</span><span>,</span><span></span>
<span>    </span><span>howpublished</span><span> </span><span>=</span><span> </span><span>{\url{https://madewithml.com/}}</span><span>,</span><span></span>
<span>    </span><span>year</span><span>         </span><span>=</span><span> </span><span>{2022}</span><span></span>
<span>}</span><span></span>
</code></pre></div></td></tr></tbody></table>