---
layout:     post
title:      ML 系统的日志记录
subtitle:   2022年10月
date:       2022-10-10
author:     franztao
header-img: post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - Logging for ML Systems

---
## 直觉

日志记录是跟踪和记录应用程序中发生的关键事件的过程，用于检查、调试等。它们比`print`语句更强大，因为它们允许将特定的信息片段发送到具有自定义功能的特定位置格式化、共享接口等。这使得日志记录成为能够从应用程序的内部流程中发现有洞察力的信息的关键支持者。

## 成分

有几个总体概念需要注意：

-   `Logger`: 从应用程序发出日志消息。
-   `Handler`：将日志记录发送到特定位置。
-   `Formatter`: 格式化和样式化日志记录。

[日志记录还有](https://docs.python.org/3/library/logging.html)很多，例如过滤器、异常日志记录等，但这些基础知识将使能够为应用程序做需要的一切。

## 级别

在创建专门的配置记录器之前，让看看使用基本配置记录的消息是什么样子的。

<table><tbody><tr><td><div><pre><span></span><span><span><span>1 </span></span></span>
<span><span><span>2 </span></span></span>
<span><span><span>3 </span></span></span>
<span><span><span>4 </span></span></span>
<span><span><span>5 </span></span></span>
<span><span><span>6 </span></span></span>
<span><span><span>7 </span></span></span>
<span><span><span>8 </span></span></span>
<span><span><span>9 </span></span></span>
<span><span><span>10 </span></span></span>
<span><span><span>11 </span></span></span>
<span><span><span>12</span></span></span></pre></div></td><td><div><pre id="__code_1"><span></span><code tabindex="0"><span>import</span> <span>logging</span>
<span>import</span> <span>sys</span><span></span>
<span></span>
<span># Create super basic logger</span>
<span>logging</span><span>.</span><span>basicConfig</span><span>(</span><span>stream</span><span>=</span><span>sys</span><span>.</span><span>stdout</span><span>,</span> <span>level</span><span>=</span><span>logging</span><span>.</span><span>DEBUG</span><span>)</span><span></span>
<span></span>
<span># Logging levels (from lowest to highest priority)</span>
<span>logging</span><span>.</span><span>debug</span><span>(</span><span>"Used for debugging your code."</span><span>)</span>
<span>logging</span><span>.</span><span>info</span><span>(</span><span>"Informative messages from your code."</span><span>)</span>
<span>logging</span><span>.</span><span>warning</span><span>(</span><span>"Everything works but there is something to be aware of."</span><span>)</span>
<span>logging</span><span>.</span><span>error</span><span>(</span><span>"There's been a mistake with the process."</span><span>)</span>
<span>logging</span><span>.</span><span>critical</span><span>(</span><span>"There is something terribly wrong and process may terminate."</span><span>)</span>
</code></pre></div></td></tr></tbody></table>

```
DEBUG:root:用于调试你的代码。
INFO:root: 来自您的代码的信息性消息。
警告：root：一切正常，但有一些事情需要注意。
ERROR:root: 进程出现错误。
CRITICAL:root: 出现严重错误，进程可能会终止。

```

这些是日志记录的基本[级别](https://docs.python.org/3/library/logging.html#logging-levels)，其中`DEBUG`优先级最低，优先级`CRITICAL`最高。定义了记录器，[`basicConfig`](https://docs.python.org/3/library/logging.html#logging.basicConfig)用于将日志消息发送到标准输出（即终端控制台），但也可以写入任何其他流甚至文件。还将日志定义为对从 level 开始的日志消息敏感`DEBUG`。这意味着所有记录的消息都将显示，因为`DEBUG`它是最低级别。如果设置了 level ，`ERROR`那么只会显示日志消息。`ERROR``CRITICAL`

<table><tbody><tr><td><div><pre><span></span><span><span><span>1 </span></span></span>
<span><span><span>2 </span></span></span>
<span><span><span>3 </span></span></span>
<span><span><span>4 </span></span></span>
<span><span><span>5 </span></span></span>
<span><span><span>6 </span></span></span>
<span><span><span>7 </span></span></span>
<span><span><span>8 </span></span></span>
<span><span><span>9 </span></span></span>
<span><span><span>10 </span></span></span>
<span><span><span>11 </span></span></span>
<span><span><span>12</span></span></span></pre></div></td><td><div><pre id="__code_2"><span></span><code tabindex="0"><span>import</span> <span>logging</span>
<span>import</span> <span>sys</span><span></span>
<span></span>
<span># Create super basic logger</span>
<span><span>logging</span><span>.</span><span>basicConfig</span><span>(</span><span>stream</span><span>=</span><span>sys</span><span>.</span><span>stdout</span><span>,</span> <span>level</span><span>=</span><span>logging</span><span>.</span><span>ERROR</span><span>)</span>
</span>
<span># Logging levels (from lowest to highest priority)</span>
<span>logging</span><span>.</span><span>debug</span><span>(</span><span>"Used for debugging your code."</span><span>)</span>
<span>logging</span><span>.</span><span>info</span><span>(</span><span>"Informative messages from your code."</span><span>)</span>
<span>logging</span><span>.</span><span>warning</span><span>(</span><span>"Everything works but there is something to be aware of."</span><span>)</span>
<span>logging</span><span>.</span><span>error</span><span>(</span><span>"There's been a mistake with the process."</span><span>)</span>
<span>logging</span><span>.</span><span>critical</span><span>(</span><span>"There is something terribly wrong and process may terminate."</span><span>)</span>
</code></pre></div></td></tr></tbody></table>

```
ERROR:root: 进程出现错误。
CRITICAL:root: 出现严重错误，进程可能会终止。

```

## 配置

首先，将在`config.py`脚本中设置日志的位置：

<table><tbody><tr><td></td><td><div><pre id="__code_3"><span></span><code><span># config/config.py</span>
<span>LOGS_DIR</span> <span>=</span> <span>Path</span><span>(</span><span>BASE_DIR</span><span>,</span> <span>"logs"</span><span>)</span>
<span>LOGS_DIR</span><span>.</span><span>mkdir</span><span>(</span><span>parents</span><span>=</span><span>True</span><span>,</span> <span>exist_ok</span><span>=</span><span>True</span><span>)</span>
</code></pre></div></td></tr></tbody></table>

接下来，将为应用程序配置记录器：

<table><tbody><tr><td><div><pre><span></span><span><span><span>1 </span></span></span>
<span><span><span>2 </span></span></span>
<span><span><span>3 </span></span></span>
<span><span><span>4 </span></span></span>
<span><span><span>5 </span></span></span>
<span><span><span>6 </span></span></span>
<span><span><span>7 </span></span></span>
<span><span><span>8 </span></span></span>
<span><span><span>9 </span></span></span>
<span><span><span>10 </span></span></span>
<span><span><span>11 </span></span></span>
<span><span><span>12 </span></span></span>
<span><span><span>13 </span></span></span>
<span><span><span>14 </span></span></span>
<span><span><span>15 </span></span></span>
<span><span><span>16 </span></span></span>
<span><span><span>17 </span></span></span>
<span><span><span>18 </span></span></span>
<span><span><span>19 </span></span></span>
<span><span><span>20 </span></span></span>
<span><span><span>21 </span></span></span>
<span><span><span>22 </span></span></span>
<span><span><span>23 </span></span></span>
<span><span><span>24 </span></span></span>
<span><span><span>25 </span></span></span>
<span><span><span>26 </span></span></span>
<span><span><span>27 </span></span></span>
<span><span><span>28 </span></span></span>
<span><span><span>29 </span></span></span>
<span><span><span>30 </span></span></span>
<span><span><span>31 </span></span></span>
<span><span><span>32 </span></span></span>
<span><span><span>33 </span></span></span>
<span><span><span>34 </span></span></span>
<span><span><span>35 </span></span></span>
<span><span><span>36 </span></span></span>
<span><span><span>37 </span></span></span>
<span><span><span>38 </span></span></span>
<span><span><span>39 </span></span></span>
<span><span><span>40 </span></span></span>
<span><span><span>41 </span></span></span>
<span><span><span>42</span></span></span></pre></div></td><td><div><pre id="__code_4"><span></span><code tabindex="0"><span># config/config.py</span>
<span>import</span> <span>logging</span>
<span>import</span> <span>sys</span>
<span>logging_config</span> <span>=</span> <span>{</span>
    <span>"version"</span><span>:</span> <span>1</span><span>,</span>
    <span>"disable_existing_loggers"</span><span>:</span> <span>False</span><span>,</span>
    <span>"formatters"</span><span>:</span> <span>{</span>
        <span>"minimal"</span><span>:</span> <span>{</span><span>"format"</span><span>:</span> <span>"</span><span>%(message)s</span><span>"</span><span>},</span>
        <span>"detailed"</span><span>:</span> <span>{</span>
            <span>"format"</span><span>:</span> <span>"</span><span>%(levelname)s</span><span> </span><span>%(asctime)s</span><span> [</span><span>%(name)s</span><span>:</span><span>%(filename)s</span><span>:</span><span>%(funcName)s</span><span>:</span><span>%(lineno)d</span><span>]</span><span>\n</span><span>%(message)s</span><span>\n</span><span>"</span>
        <span>},</span>
    <span>},</span>
    <span>"handlers"</span><span>:</span> <span>{</span>
        <span>"console"</span><span>:</span> <span>{</span>
            <span>"class"</span><span>:</span> <span>"logging.StreamHandler"</span><span>,</span>
            <span>"stream"</span><span>:</span> <span>sys</span><span>.</span><span>stdout</span><span>,</span>
            <span>"formatter"</span><span>:</span> <span>"minimal"</span><span>,</span>
            <span>"level"</span><span>:</span> <span>logging</span><span>.</span><span>DEBUG</span><span>,</span>
        <span>},</span>
        <span>"info"</span><span>:</span> <span>{</span>
            <span>"class"</span><span>:</span> <span>"logging.handlers.RotatingFileHandler"</span><span>,</span>
            <span>"filename"</span><span>:</span> <span>Path</span><span>(</span><span>LOGS_DIR</span><span>,</span> <span>"info.log"</span><span>),</span>
            <span>"maxBytes"</span><span>:</span> <span>10485760</span><span>,</span>  <span># 1 MB</span>
            <span>"backupCount"</span><span>:</span> <span>10</span><span>,</span>
            <span>"formatter"</span><span>:</span> <span>"detailed"</span><span>,</span>
            <span>"level"</span><span>:</span> <span>logging</span><span>.</span><span>INFO</span><span>,</span>
        <span>},</span>
        <span>"error"</span><span>:</span> <span>{</span>
            <span>"class"</span><span>:</span> <span>"logging.handlers.RotatingFileHandler"</span><span>,</span>
            <span>"filename"</span><span>:</span> <span>Path</span><span>(</span><span>LOGS_DIR</span><span>,</span> <span>"error.log"</span><span>),</span>
            <span>"maxBytes"</span><span>:</span> <span>10485760</span><span>,</span>  <span># 1 MB</span>
            <span>"backupCount"</span><span>:</span> <span>10</span><span>,</span>
            <span>"formatter"</span><span>:</span> <span>"detailed"</span><span>,</span>
            <span>"level"</span><span>:</span> <span>logging</span><span>.</span><span>ERROR</span><span>,</span>
        <span>},</span>
    <span>},</span>
    <span>"root"</span><span>:</span> <span>{</span>
        <span>"handlers"</span><span>:</span> <span>[</span><span>"console"</span><span>,</span> <span>"info"</span><span>,</span> <span>"error"</span><span>],</span>
        <span>"level"</span><span>:</span> <span>logging</span><span>.</span><span>INFO</span><span>,</span>
        <span>"propagate"</span><span>:</span> <span>True</span><span>,</span>
    <span>},</span>
<span>}</span>
</code></pre></div></td></tr></tbody></table>

1.  `[Lines 6-11]`: define two different [Formatters](https://docs.python.org/3/library/logging.html#formatter-objects) (determine format and style of log messages), minimal and detailed, which use various [LogRecord attributes](https://docs.python.org/3/library/logging.html#logrecord-attributes) to create a formatting template for log messages.
2.  `[Lines 12-35]`: define the different [Handlers](https://docs.python.org/3/library/logging.html#handler-objects) (details about location of where to send log messages):
    -   `console`: sends log messages (using the `minimal` formatter) to the `stdout` stream for messages above level `DEBUG` (ie. all logged messages).
    -   `info`: send log messages (using the `detailed` formatter) to `logs/info.log` (a file that can be up to `1 MB` and we'll backup the last `10` versions of it) for messages above level `INFO`.
    -   `error`: send log messages (using the `detailed` formatter) to `logs/error.log` (a file that can be up to `1 MB` and we'll backup the last `10` versions of it) for messages above level `ERROR`.
3.  `[Lines 36-40]`: attach our different handlers to our root [Logger](https://docs.python.org/3/library/logging.html#logger-objects).

We chose to use a dictionary to configure our logger but there are other ways such as Python script, configuration file, etc. Click on the different options below to expand and view the respective implementation.

Python script

<table><tbody><tr><td><div><pre><span></span><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
<span>30</span>
<span>31</span>
<span>32</span>
<span>33</span>
<span>34</span>
<span>35</span>
<span>36</span></pre></div></td><td><div><pre><span></span><code><span>import</span> <span>logging</span>
<span>from</span> <span>rich.logging</span> <span>import</span> <span>RichHandler</span><span></span>
<span></span>
<span># Get root logger</span>
<span>logger</span> <span>=</span> <span>logging</span><span>.</span><span>getLogger</span><span>()</span>
<span>logger</span><span>.</span><span>setLevel</span><span>(</span><span>logging</span><span>.</span><span>DEBUG</span><span>)</span><span></span>
<span></span>
<span># Create handlers</span>
<span>console_handler</span> <span>=</span> <span>RichHandler</span><span>(</span><span>markup</span><span>=</span><span>True</span><span>)</span>
<span>console_handler</span><span>.</span><span>setLevel</span><span>(</span><span>logging</span><span>.</span><span>DEBUG</span><span>)</span>
<span>info_handler</span> <span>=</span> <span>logging</span><span>.</span><span>handlers</span><span>.</span><span>RotatingFileHandler</span><span>(</span>
    <span>filename</span><span>=</span><span>Path</span><span>(</span><span>LOGS_DIR</span><span>,</span> <span>"info.log"</span><span>),</span>
    <span>maxBytes</span><span>=</span><span>10485760</span><span>,</span>  <span># 1 MB</span>
    <span>backupCount</span><span>=</span><span>10</span><span>,</span>
<span>)</span>
<span>info_handler</span><span>.</span><span>setLevel</span><span>(</span><span>logging</span><span>.</span><span>INFO</span><span>)</span>
<span>error_handler</span> <span>=</span> <span>logging</span><span>.</span><span>handlers</span><span>.</span><span>RotatingFileHandler</span><span>(</span>
    <span>filename</span><span>=</span><span>Path</span><span>(</span><span>LOGS_DIR</span><span>,</span> <span>"error.log"</span><span>),</span>
    <span>maxBytes</span><span>=</span><span>10485760</span><span>,</span>  <span># 1 MB</span>
    <span>backupCount</span><span>=</span><span>10</span><span>,</span>
<span>)</span>
<span>error_handler</span><span>.</span><span>setLevel</span><span>(</span><span>logging</span><span>.</span><span>ERROR</span><span>)</span><span></span>
<span></span>
<span># Create formatters</span>
<span>minimal_formatter</span> <span>=</span> <span>logging</span><span>.</span><span>Formatter</span><span>(</span><span>fmt</span><span>=</span><span>"</span><span>%(message)s</span><span>"</span><span>)</span>
<span>detailed_formatter</span> <span>=</span> <span>logging</span><span>.</span><span>Formatter</span><span>(</span>
    <span>fmt</span><span>=</span><span>"</span><span>%(levelname)s</span><span> </span><span>%(asctime)s</span><span> [</span><span>%(name)s</span><span>:</span><span>%(filename)s</span><span>:</span><span>%(funcName)s</span><span>:</span><span>%(lineno)d</span><span>]</span><span>\n</span><span>%(message)s</span><span>\n</span><span>"</span>
<span>)</span><span></span>
<span></span>
<span># Hook it all up</span>
<span>console_handler</span><span>.</span><span>setFormatter</span><span>(</span><span>fmt</span><span>=</span><span>minimal_formatter</span><span>)</span>
<span>info_handler</span><span>.</span><span>setFormatter</span><span>(</span><span>fmt</span><span>=</span><span>detailed_formatter</span><span>)</span>
<span>error_handler</span><span>.</span><span>setFormatter</span><span>(</span><span>fmt</span><span>=</span><span>detailed_formatter</span><span>)</span>
<span>logger</span><span>.</span><span>addHandler</span><span>(</span><span>hdlr</span><span>=</span><span>console_handler</span><span>)</span>
<span>logger</span><span>.</span><span>addHandler</span><span>(</span><span>hdlr</span><span>=</span><span>info_handler</span><span>)</span>
<span>logger</span><span>.</span><span>addHandler</span><span>(</span><span>hdlr</span><span>=</span><span>error_handler</span><span>)</span>
</code></pre></div></td></tr></tbody></table>
Configuration file

1.  Place this inside a `logging.config` file:
    
    ```
    [formatters]
    keys=minimal,detailed
    
    [formatter_minimal]
    format=%(message)s
    
    [formatter_detailed]
    format=
        %(levelname)s %(asctime)s [%(name)s:%(filename)s:%(funcName)s:%(lineno)d]
        %(message)s
    
    [handlers]
    keys=console,info,error
    
    [handler_console]
    class=StreamHandler
    level=DEBUG
    formatter=minimal
    args=(sys.stdout,)
    
    [handler_info]
    class=handlers.RotatingFileHandler
    level=INFO
    formatter=detailed
    backupCount=10
    maxBytes=10485760
    args=("logs/info.log",)
    
    [handler_error]
    class=handlers.RotatingFileHandler
    level=ERROR
    formatter=detailed
    backupCount=10
    maxBytes=10485760
    args=("logs/error.log",)
    
    [loggers]
    keys=root
    
    [logger_root]
    level=INFO
    handlers=console,info,error
    
    ```
    
2.  Place this inside your Python script:
    
    <table><tbody><tr><td></td><td><div><pre><span></span><code><span>import</span> <span>logging</span>
    <span>import</span> <span>logging.config</span>
    <span>from</span> <span>rich.logging</span> <span>import</span> <span>RichHandler</span><span></span>
    <span></span>
    <span># Use config file to initialize logger</span>
    <span>logging</span><span>.</span><span>config</span><span>.</span><span>fileConfig</span><span>(</span><span>Path</span><span>(</span><span>CONFIG_DIR</span><span>,</span> <span>"logging.config"</span><span>))</span>
    <span>logger</span> <span>=</span> <span>logging</span><span>.</span><span>getLogger</span><span>()</span>
    <span>logger</span><span>.</span><span>handlers</span><span>[</span><span>0</span><span>]</span> <span>=</span> <span>RichHandler</span><span>(</span><span>markup</span><span>=</span><span>True</span><span>)</span>  <span># set rich handler</span>
    </code></pre></div></td></tr></tbody></table>

We can load our logger configuration dict like so:

<table><tbody><tr><td><div><pre><span></span><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span></pre></div></td><td><div><pre><span></span><code><span># config/config.py</span>
<span>from</span> <span>rich.logging</span> <span>import</span> <span>RichHandler</span>
<span>logging</span><span>.</span><span>config</span><span>.</span><span>dictConfig</span><span>(</span><span>logging_config</span><span>)</span>
<span>logger</span> <span>=</span> <span>logging</span><span>.</span><span>getLogger</span><span>()</span>
<span>logger</span><span>.</span><span>handlers</span><span>[</span><span>0</span><span>]</span> <span>=</span> <span>RichHandler</span><span>(</span><span>markup</span><span>=</span><span>True</span><span>)</span>  <span># pretty formatting</span><span></span>
<span></span>
<span># Sample messages (note that we use configured `logger` now)</span>
<span>logger</span><span>.</span><span>debug</span><span>(</span><span>"Used for debugging your code."</span><span>)</span>
<span>logger</span><span>.</span><span>info</span><span>(</span><span>"Informative messages from your code."</span><span>)</span>
<span>logger</span><span>.</span><span>warning</span><span>(</span><span>"Everything works but there is something to be aware of."</span><span>)</span>
<span>logger</span><span>.</span><span>error</span><span>(</span><span>"There's been a mistake with the process."</span><span>)</span>
<span>logger</span><span>.</span><span>critical</span><span>(</span><span>"There is something terribly wrong and process may terminate."</span><span>)</span>
</code></pre></div></td></tr></tbody></table>

```
DEBUG    Used for debugging your code.                                 config.py:71
INFO     Informative messages from your code.                          config.py:72
WARNING  Everything works but there is something to be aware of.       config.py:73
ERROR    There's been a mistake with the process.                      config.py:74
CRITICAL There is something terribly wrong and process may terminate.  config.py:75

```

We use [RichHandler](https://rich.readthedocs.io/en/stable/logging.html) for our `console` handler to get pretty formatting for the log messages. This is not a preinstalled library so we'll need to install and add to `requirements.txt`:

```
# Add to requirements.txt
rich==12.4.4

```

Our logged messages become stored inside the respective files in our logs directory:

```
logs/
    ├── info.log
    └── error.log

```

And since we defined a detailed formatter, we would see informative log messages like these:

```
INFO 2020-10-21 11:18:42,102 [config.py:module:72]
Informative messages from your code.

```

## Application

In our project, we can replace all of our print statements into logging statements:

────   becomes:   ────

<table><tbody><tr><td></td><td><div><pre><span></span><code><span>from</span> <span>config.config</span> <span>import</span> <span>logger</span>
<span>logger</span><span>.</span><span>info</span><span>(</span><span>"✅ Saved data!"</span><span>)</span>
</code></pre></div></td></tr></tbody></table>

All of our log messages are at the `INFO` level but while developing we may have had to use `DEBUG` levels and we also add some `ERROR` or `CRITICAL` log messages if our system behaves in an unintended manner.

-   **what**: log all the necessary details you want to surface from our application that will be useful _during_ development and _afterwards_ for retrospective inspection.
    
-   **where**: a best practice is to not clutter our modular functions with log statements. Instead we should log messages outside of small functions and inside larger workflows. For example, there are no log messages inside any of our scripts except the `main.py` and `train.py` files. This is because these scripts use the smaller functions defined in the other scripts (data.py, evaluate.py, etc.). If we ever feel that we the need to log within our other functions, then it usually indicates that the function needs to be broken down further.
    

> [Elastic 堆栈](https://www.elastic.co/what-is/elk-stack)（以前的ELK 堆栈）是生产级日志记录的常用选项。它结合了[Elasticsearch](https://www.elastic.co/elasticsearch/)（分布式搜索引擎）、[Logstash](https://www.elastic.co/logstash)（摄取管道）和[Kibana](https://www.elastic.co/kibana)（可定制的可视化）的特性。也可以简单地将日志[上传](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-uploading-files.html)到云博客存储（例如 S3、谷歌云存储等）。

___

本文主体源自以下链接：
```
@article{madewithml,
    author       = {Goku Mohandas},
    title        = { Made With ML },
    howpublished = {\url{https://madewithml.com/}},
    year         = {2022}
}
```